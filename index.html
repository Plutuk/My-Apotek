<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>My-Apotek Pro | Riil Data Reporting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
</head>
<body class="bg-light">

<div class="container py-4">
    <h2 class="text-center mb-4">Sistem Manajemen My-Apotek 2026</h2>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">ðŸ“¦ 1. Logistik (Input Barang Datang)</div>
        <div class="card-body row g-3">
            <div class="col-md-3"><label>Nama Obat</label><input type="text" id="a1_nama" class="form-control" value="Metformin 500mg"></div>
            <div class="col-md-3"><label>Supplier</label><input type="text" id="a1_supplier" class="form-control" value="Kimia Farma"></div>
            <div class="col-md-2"><label>No. Batch</label><input type="text" id="a1_batch" class="form-control" value="BATCH-001"></div>
            <div class="col-md-2"><label>Tgl Produksi</label><input type="date" id="a1_prod" class="form-control" value="2025-01-01"></div>
            <div class="col-md-2"><label>Tgl Expired</label><input type="date" id="a1_exp" class="form-control" value="2026-12-01"></div>
            <div class="col-md-3"><label>Harga Beli (Satuan)</label><input type="number" id="a1_harga" class="form-control" value="2000"></div>
            <div class="col-md-3"><label>Stok Masuk</label><input type="number" id="a1_qty" class="form-control" value="1000"></div>
            <div class="col-md-6 d-flex align-items-end"><button onclick="JsBarcode('#barcode', document.getElementById('a1_batch').value)" class="btn btn-dark w-100">Generate Barcode</button></div>
            <div class="col-12 text-center"><svg id="barcode"></svg></div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-warning">
        <div class="card-header bg-warning text-dark">ðŸ“œ 2. Layanan Klinis & Penjualan Pasien</div>
        <div class="card-body row g-3">
            <div class="col-md-4"><label>Nama Pasien</label><input type="text" id="a2_nama_p" class="form-control" value="Budianto"></div>
            <div class="col-md-4"><label>Diagnosa Dokter</label><input type="text" id="a2_diag" class="form-control" value="Diabetes Melitus"></div>
            <div class="col-md-4"><label>Obat Resep</label><input type="text" id="a2_obat" class="form-control" value="Metformin 500mg"></div>
            <div class="col-md-2"><label>Qty Jual</label><input type="number" id="a2_qty_jual" class="form-control" value="30"></div>
            <div class="col-md-3"><label>Riwayat Alergi</label><input type="text" id="a2_alergi" class="form-control" placeholder="Kosongkan jika aman"></div>
            <div class="col-md-3"><label>Metode Bayar</label><select id="a2_metode" class="form-select"><option value="Tunai">Tunai</option><option value="Asuransi">Asuransi (Piutang)</option></select></div>
            <div class="col-md-4 d-flex align-items-end"><button onclick="runKlinis()" class="btn btn-warning w-100 fw-bold">Jalankan Rule Engine</button></div>
            <div id="res_klinis" class="col-12 p-3 text-center fw-bold rounded bg-white border mt-2">Status Analisis Klinis: -</div>
        </div>
    </div>

    <div class="card mb-4 shadow-sm border-success">
        <div class="card-header bg-success text-white">ðŸ“Š 3. Audit Stok Opname</div>
        <div class="card-body row g-3">
            <div class="col-md-6 text-center"><h6>Stok Sistem: <span id="stok_sistem">1000</span></h6></div>
            <div class="col-md-6"><input type="number" id="a3_fisik" class="form-control" placeholder="Input Stok Fisik (Manual/Scan)"></div>
            <div class="col-12"><button onclick="runAudit()" class="btn btn-success w-100">Hitung Selisih & Audit</button></div>
            <div id="res_audit" class="col-12 p-2 text-center fw-bold mt-2"></div>
        </div>
    </div>

    <div class="text-center">
        <button onclick="generateReport()" class="btn btn-danger btn-lg px-5 shadow">ðŸ“„ CETAK LAPORAN PDF RIIL</button>
    </div>
</div>

<script>
    function runKlinis() {
        const diag = document.getElementById('a2_diag').value.toLowerCase();
        const obat = document.getElementById('a2_obat').value.toLowerCase();
        const alergi = document.getElementById('a2_alergi').value.toLowerCase();
        const res = document.getElementById('res_klinis');

        if (alergi && obat.includes(alergi)) {
            res.innerHTML = "âŒ BERBAHAYA: Interaksi Alergi Terdeteksi!";
            res.className = "col-12 p-3 text-center fw-bold rounded bg-danger text-white mt-2";
        } else if (diag === "diabetes" && !obat.includes("metformin")) {
            res.innerHTML = "âš ï¸ PERINGATAN: Obat Tidak Sesuai Diagnosa!";
            res.className = "col-12 p-3 text-center fw-bold rounded bg-warning text-dark mt-2";
        } else {
            res.innerHTML = "âœ… AMAN: Compliance Pasien Terjaga.";
            res.className = "col-12 p-3 text-center fw-bold rounded bg-success text-white mt-2";
        }
    }

    function runAudit() {
        const fisik = parseFloat(document.getElementById('a3_fisik').value) || 0;
        const sistem = 1000;
        const selisih = Math.abs((sistem - fisik) / sistem) * 100;
        const res = document.getElementById('res_audit');
        res.innerHTML = selisih > 5 ? `âŒ Selisih ${selisih.toFixed(1)}% - Butuh Approval!` : `âœ… Selisih ${selisih.toFixed(1)}% - Auto Adjust`;
        res.className = "col-12 p-2 text-center fw-bold mt-2 " + (selisih > 5 ? "bg-danger text-white" : "bg-success text-white");
    }

    function generateReport() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Kalkulasi Keuangan Riil
        const hargaBeli = parseFloat(document.getElementById('a1_harga').value);
        const qtyJual = parseFloat(document.getElementById('a2_qty_jual').value);
        const margin = 0.3; // 30%
        const hargaJual = hargaBeli * (1 + margin);
        const total = hargaJual * qtyJual;
        const hpp = hargaBeli * qtyJual;
        const metode = document.getElementById('a2_metode').value;

        doc.setFontSize(14); doc.text("LAPORAN OPERASIONAL RIIL APOTEK", 105, 15, { align: "center" });

        // 1. Laporan Keuangan
        doc.autoTable({
            startY: 25, head: [['1. Laporan Keuangan', 'Nilai Riil']],
            body: [
                ['Pendapatan Pasien', 'Rp ' + (metode === "Tunai" ? total.toLocaleString() : 0)],
                ['HPP & Margin', `HPP: Rp ${hpp.toLocaleString()} | Margin: 30%`],
                ['Piutang (Asuransi)', 'Rp ' + (metode === "Asuransi" ? total.toLocaleString() : 0)],
                ['Cash Flow', metode === "Tunai" ? 'Positif' : 'Pending Klaim']
            ]
        });

        // 2. Laporan Barang
        const fisik = parseFloat(document.getElementById('a3_fisik').value) || 0;
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            head: [['2. Laporan Barang', 'Keterangan']],
            body: [
                ['Barang Datang', `${document.getElementById('a1_supplier').value} (Batch: ${document.getElementById('a1_batch').value})`],
                ['Barang Keluar', `${document.getElementById('a2_obat').value} (${qtyJual} unit)`],
                ['Fast Moving Item', document.getElementById('a2_obat').value],
                ['Expired Tracking', `Exp: ${document.getElementById('a1_exp').value} (Monitor)`],
                ['Selisih Audit (Rp)', 'Rp ' + (Math.abs(1000 - fisik) * hargaBeli).toLocaleString()]
            ]
        });

        // 3. Laporan Klinis
        doc.autoTable({
            startY: doc.lastAutoTable.finalY + 10,
            head: [['3. Laporan Klinis', 'Status Analisis']],
            body: [
                ['Resep Terbanyak', document.getElementById('a2_obat').value],
                ['Interaksi Obat', document.getElementById('res_klinis').innerText],
                ['Compliance Alert', 'Pemantauan Dosis & Usia Aktif']
            ]
        });

        doc.save("Laporan_Riil_Apotek_2026.pdf");
    }
</script>
</body>
</html>
